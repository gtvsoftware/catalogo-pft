# Utilitários

Funções utilitárias para autenticação e gerenciamento de sessão.

## Cliente HTTP com Autenticação

### createAxiosInstance

Cria uma instância do Axios completamente configurada com autenticação automática, refresh de tokens e tratamento de erros. Funciona tanto no cliente quanto no servidor.

```tsx
import { createAxiosInstance } from "lib-auth"

// Configuração básica
const api = createAxiosInstance({
  baseURL: 'https://api.exemplo.com'
})

// Usar normalmente
const response = await api.get('/users')
const newUser = await api.post('/users', userData)
```

#### Configuração Avançada

```tsx
const api = createAxiosInstance({
  baseURL: 'https://api.exemplo.com',
  timeout: 15000,
  defaultHeaders: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  },
  enableDebugLogs: process.env.NODE_ENV === 'development',
  
  // Callback quando refresh token falha
  onRefreshError: async () => {
    console.log('Redirecionando para login...')
    window.location.href = '/auth/signin'
  },
  
  // Callback para requisições não autorizadas
  onUnauthorized: async (error) => {
    console.warn('Requisição não autorizada:', error.config?.url)
  }
})
```

#### Uso em Componentes React

```tsx
import React, { useEffect, useState } from 'react'
import { createAxiosInstance } from 'lib-auth'

interface User {
  id: string
  name: string
  email: string
}

export function UsersList() {
  const [users, setUsers] = useState<User[]>([])
  const [loading, setLoading] = useState(false)
  
  // Criar instância (considere usar useMemo para otimização)
  const api = React.useMemo(() => createAxiosInstance({
    baseURL: process.env.NEXT_PUBLIC_API_URL
  }), [])
  
  useEffect(() => {
    loadUsers()
  }, [])
  
  const loadUsers = async () => {
    setLoading(true)
    try {
      const response = await api.get<User[]>('/users')
      setUsers(response.data)
    } catch (error) {
      console.error('Erro ao carregar usuários:', error)
    } finally {
      setLoading(false)
    }
  }
  
  return (
    <div>
      {loading ? <p>Carregando...</p> : (
        <ul>
          {users.map(user => (
            <li key={user.id}>{user.name}</li>
          ))}
        </ul>
      )}
    </div>
  )
}
```

#### Múltiplas APIs

```tsx
// Organize diferentes APIs em classes
export class ApiClients {
  static readonly users = createAxiosInstance({
    baseURL: 'https://users-api.exemplo.com',
    defaultHeaders: { 'Service': 'users' }
  })
  
  static readonly orders = createAxiosInstance({
    baseURL: 'https://orders-api.exemplo.com',
    defaultHeaders: { 'Service': 'orders' }
  })
}

// Uso
const [profile, orders] = await Promise.all([
  ApiClients.users.get('/profile'),
  ApiClients.orders.get('/recent')
])
```

#### Recursos Automáticos

✅ **Autenticação Automática**
- Headers Authorization adicionados automaticamente
- Tokens obtidos da sessão NextAuth

✅ **Refresh Automático de Tokens**
- Tokens expirados são renovados automaticamente
- Requisições repetidas após refresh bem-sucedido
- Múltiplos refreshes simultâneos evitados

✅ **Compatibilidade Client/Server**
- Funciona no navegador e em Server Components
- Detecção automática do ambiente
- Session handling apropriado para cada contexto

✅ **Tratamento de Erros**
- Erros 401/403 disparam refresh automático
- Callbacks customizáveis para diferentes cenários
- Redirecionamento automático em falhas críticas

#### Interface de Configuração

```typescript
interface CreateAxiosInstanceConfig {
  baseURL: string
  timeout?: number // padrão: 30000ms
  defaultHeaders?: Record<string, string>
  axiosConfig?: AxiosRequestConfig
  onRefreshError?: () => void | Promise<void>
  onUnauthorized?: (error: AxiosError) => void | Promise<void>
  enableDebugLogs?: boolean // padrão: false
}
```

### useAxiosInstance

Alias para `createAxiosInstance` com nome mais intuitivo para uso em componentes React:

```tsx
import { useAxiosInstance } from "lib-auth"

function MyComponent() {
  const api = useAxiosInstance({
    baseURL: 'https://api.exemplo.com'
  })
  
  // ... usar api normalmente
}
```

## Utilitários de URL

### Funções de URL do ambiente

Recupere URLs a partir das variáveis de ambiente com valores padrão adequados:

```tsx
import { 
  appUrlFromEnv, 
  authUrlFromEnv, 
  basePathFromEnv, 
  fullUrlFromEnv 
} from "lib-auth"

// URL da aplicação
const appUrl = appUrlFromEnv // de NEXT_PUBLIC_APP_URL

// URL de autenticação
const authUrl = authUrlFromEnv // de AUTH_URL

// Base path da aplicação
const basePath = basePathFromEnv // de NEXT_PUBLIC_BASE_PATH

// URL completa (app + base path)
const fullUrl = fullUrlFromEnv
```

### getDomainWithoutSubdomain

Extrai o domínio principal sem subdomínios:

```tsx
import { getDomainWithoutSubdomain } from "lib-auth"

const domain = getDomainWithoutSubdomain('app.subdomain.terraviva.agr.br')
// Retorna: 'terraviva.agr.br'

const localDomain = getDomainWithoutSubdomain('local.dev.terraviva')
// Retorna: 'dev.terraviva'
```

## Utilitários de Sessão

### getSessionStatus

Obtém o status atual da sessão:

```tsx
import { getSessionStatus } from "lib-auth"

const status = await getSessionStatus()
// Retorna: 'authenticated' | 'unauthenticated' | 'loading'
```

## Utilitários de Token

### getTokenFromIssuer

Obtém tokens diretamente do issuer do Keycloak:

```tsx
import { getTokenFromIssuer, type GetTokenFromIssuerProps } from "lib-auth"

const props: GetTokenFromIssuerProps = {
  issuer: 'https://login.terraviva.agr.br/realms/terraviva',
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
  username: 'user@example.com',
  password: 'password'
}

try {
  const tokens = await getTokenFromIssuer(props)
  console.log('Access token:', tokens.access_token)
  console.log('Refresh token:', tokens.refresh_token)
} catch (error) {
  console.error('Falha ao obter token:', error)
}
```

#### Parâmetros

| Parâmetro      | Tipo     | Obrigatório | Descrição                 |
| -------------- | -------- | ----------- | ------------------------- |
| `issuer`       | `string` | ✅           | URL do issuer no Keycloak |
| `clientId`     | `string` | ✅           | Client ID                 |
| `clientSecret` | `string` | ✅           | Client Secret             |
| `username`     | `string` | ✅           | Email/usuário             |
| `password`     | `string` | ✅           | Senha do usuário          |

#### Retorno

```typescript
{
  access_token: string
  refresh_token: string
  token_type: 'Bearer'
  expires_in: number
  // ... outros campos do token
}
```

## Variáveis de Ambiente

As funções utilitárias leem automaticamente destas variáveis:

* `NEXT_PUBLIC_APP_URL` – URL principal da aplicação
* `NEXT_PUBLIC_BASE_PATH` – Base path da aplicação (opcional)
* `AUTH_URL` – URL do NextAuth.js para autenticação
* `AUTH_ISSUER_URL` – URL do issuer do Keycloak
* `AUTH_CLIENT_ID` – Client ID do Keycloak
* `AUTH_CLIENT_SECRET` – Client Secret do Keycloak

## Suporte a TypeScript

Todos os utilitários possuem definições completas em TypeScript:

```tsx
import type { GetTokenFromIssuerProps } from "lib-auth"

// Todos os tipos são exportados para uso direto na sua aplicação
