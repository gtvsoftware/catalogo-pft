# Guia de Configuração

## Instalação

Este pacote não está publicado no **npm**. Para utilizá-lo, você deve adicioná-lo como **submódulo Git** dentro do diretório `packages/` do seu monorepo:

```bash
git submodule add https://github.com/gtvsoftware/lib-auth.git packages/auth
```

Depois, adicione o caminho no seu `pnpm-workspace.yaml`:

```yaml
packages:
  - "apps/*"
  - "packages/*"
```

Por fim, rode:

```bash
pnpm install
```

Agora você pode importar usando:

```ts
import { AuthProvider } from "@terraviva/auth"
```

---

## Variáveis de Ambiente

Configure as seguintes variáveis no arquivo `.env`:

### Desenvolvimento

```env
NEXT_PUBLIC_APP_URL=http://local.dev.terraviva
AUTH_URL=http://conta.dev.terraviva/api/auth
AUTH_SECRET=tr3fekObeswld54sevexisEda6hetra2
AUTH_ISSUER_URL=http://10.0.0.28:8080/realms/terraviva
AUTH_CLIENT_ID=seu-client-id
AUTH_CLIENT_SECRET=seu-client-secret
```

### Produção / Homologação

```env
_PUBLIC_APP_URL=https://apps.terraviva.agr.br
AUTH_URL=https://conta.terraviva.agr.br/api/auth
AUTH_SECRET=sua-secret-de-producao
AUTH_ISSUER_URL=https://login.terraviva.agr.br/realms/terraviva
AUTH_CLIENT_ID=seu-client-id
AUTH_CLIENT_SECRET=seu-client-secret
```

---

## Arquivos Necessários

### 1. Middleware

Crie `src/middleware.ts`:

```typescript
import { type NextRequest, NextResponse } from "next/server";

export async function middleware(req: NextRequest): Promise<NextResponse> {
  const requestHeaders = new Headers(req.headers);
  requestHeaders.set("x-url", req.nextUrl.href);

  return NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  });
}
```

### 2. Rota de Autenticação

Crie `src/app/api/[...auth]/route.ts`:

```typescript
'use server'

import { handler } from "@terraviva/auth";

export { handler as GET, handler as POST };
```

### 3. Página de Login

Crie `src/app/auth/signin/page.tsx`:

```typescript
'use server'

import { SignInPage } from "@terraviva/auth"

export default SignInPage
```

### 4. Página de Logout

Crie `src/app/auth/signout/page.tsx`:

```typescript
'use server'

import { SignOutPage } from "@terraviva/auth"

export default SignOutPage
```

### 5. Provider de Autenticação

Adicione ao seu `src/app/layout.tsx`:

```tsx
import { AuthProvider } from "@terraviva/auth"

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="pt-BR">
      <body>
        <AuthProvider>{children}</AuthProvider>
      </body>
    </html>
  )
}
```

### 6. Cliente HTTP Autenticado (Opcional)

Configure um cliente Axios para requisições à API:

```tsx
// lib/api.ts
import { createAxiosInstance } from "@terraviva/auth"

export const api = createAxiosInstance({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'https://api.exemplo.com',
  timeout: 30000,
  enableDebugLogs: process.env.NODE_ENV === 'development'
})

// Usar em qualquer lugar
import { api } from '@/lib/api'

// Em Server Components
async function ServerComponent() {
  const data = await api.get('/dados')
  return <div>{data.data.message}</div>
}

// Em Client Components
function ClientComponent() {
  const [data, setData] = useState(null)
  
  useEffect(() => {
    api.get('/dados').then(response => {
      setData(response.data)
    })
  }, [])
  
  return <div>{data?.message}</div>
}
```

---

## Configuração do Keycloak

### Acesso ao Ambiente de Desenvolvimento

* **Dashboard:** [http://10.0.0.28:8080](http://10.0.0.28:8080)
* **Usuário:** dev
* **Senha:** dev

### Criando um Client

1. Vá em **Clients** > **Create Client**
2. Defina o **Client ID** (esse valor será usado na env `AUTH_CLIENT_ID`)
3. Na aba **Settings**, habilite **Client authentication**
4. Na aba **Credentials**, copie o **Client Secret** (esse valor será usado em `AUTH_CLIENT_SECRET`)