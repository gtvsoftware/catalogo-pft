#!/bin/sh

# Check if the repo is in an unborn branch state (no commits yet)
if [ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" != "true" ] || [ -z "$(git branch --show-current)" ]; then
  echo "No branch detected (unborn branch state). Skipping branch name check."
  exit 0
fi

branch_name=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD)

# Lista de branches permitidas diretamente
allowed_branches="^(main|dev|homolog|v2)$"

# Padrão para nomes de branches no formato: tipo/MPM-1234-descricao
pattern="^(feature|bugfix|hotfix|release|chore)/MPM-[0-9]+-[a-z0-9-]+$"

if echo "$branch_name" | grep -Eq "$allowed_branches"; then
  # Branch permitida diretamente
  exit 0
fi

if echo "$branch_name" | grep -Eq "$pattern"; then
  # Branch segue o padrão esperado
  exit 0
fi

# Caso contrário, exibe mensagem de erro e impede o commit
echo "Erro: O nome da branch '$branch_name' não segue o padrão esperado."
echo "Padrão esperado: <tipo>/MPM-<número>-descricao-breve (ex: feature/MPM-1234-criar-tela-login)"
echo "Ou uma das branches permitidas: main, dev, homolog"
exit 1
